context("spline functions")

test_that("make_Q", {
    # check error messages
    expect_error(make_Q(NA, 1), "df must be a positive integer")
    expect_error(make_Q("aaa", 1), "df must be a positive integer")
    expect_error(make_Q(2.2, 1), "df must be a positive integer")
    expect_error(make_Q(-2, 1), "df must be a positive integer")
    expect_error(make_Q(c(1, 1), 1), "df must be a positive integer")
    expect_error(make_Q(1, 2), "phi must be a number with values between -1 and 1.")
    expect_error(make_Q(1, -2), "phi must be a number with values between -1 and 1.")
    expect_error(make_Q(1, NA), "phi must be a number with values between -1 and 1.")
    expect_error(make_Q(1, "aaa"), "phi must be a number with values between -1 and 1.")
    expect_error(make_Q(1, c(1, 1)), "phi must be a number with values between -1 and 1.")

    expect_identical(
        make_Q(2, 1),
        structure(c(2, -1, -1, 0, -1, 2, 0, -1, -1, 0, 2, -1, 0, -1, -1, 2),
                  .Dim = c(4L, 4L), .Dimnames = list(NULL, NULL))
    )

})


test_that("spline_interactions", {

    set.seed(11)
    x1 <- rnorm(10)
    x2 <- rnorm(10)

    expect_equal(
        spline_interactions(x1, x2, 5),
        structure(c(0.0269309886823068, 0, 0, 0, 0, 0, 0, 0, 9.5744165703055e-06,
                    0.0463063372933386, 0.161723868295918, 0.000318292643574712,
                    0, 0, 0.000192428777776179, 0, 0, 0, 0.0178590562519801, 0.0457105214566745,
                    0.0707050626450576, 0.000675285762823176, 0, 0, 0.0104425338340239,
                    0, 0, 0, 0.0317556788580155, 0.00513003045603798, 0.0021571289342838,
                    0.000219695625257941, 0, 0, 0.146214251775004, 0, 0, 0, 0.00829302526870444,
                    0, 0, 0, 0, 0, 0.366851638608272, 0, 0, 0, 0, 0, 0.0618654599823444,
                    0, 0, 0.185804728260049, 0, 0.0607446088576184, 0, 0, 0.000104837723710557,
                    0.310426793349085, 0.37150962485177, 0.115061748400981, 0, 0.0237528581822273,
                    0.000102653642213684, 0.0838403077796863, 0, 0, 0.195552678466406,
                    0.306432584123885, 0.162422600789653, 0.244113592033071, 0, 0.00049852073692603,
                    0.00557070592242196, 0.01212833126282, 0, 0, 0.34771759322475,
                    0.034390517525991, 0.00495532397027694, 0.0794192491360295, 0,
                    0, 0.0779999003356489, 0, 0, 0, 0.0908067750615285, 0, 0, 0,
                    0, 0, 0.195701793101858, 0, 0.320079763647466, 0, 0, 0, 0.0134116396085355,
                    0, 0, 0.310670573035508, 0, 0.2198949357324, 0, 0, 5.08550872623645e-05,
                    0.119103426058945, 0.0805385299169538, 0.13897084111593, 0, 0.0397154266837374,
                    7.83542135901592e-06, 0.303501157348987, 0, 0, 0.0948594473040509,
                    0.117570942351643, 0.0352111402177164, 0.294838829446968, 0,
                    0.000833540268114879, 0.000425204865877842, 0.0439044496908399,
                    0, 0, 0.168672190889274, 0.0131948290194127, 0.00107425078956591,
                    0.0959220592995566, 0, 0, 0.00595363273929298, 0, 0, 0, 0.0440489005896159,
                    0, 0, 0, 0, 0, 0.014937667837212, 0, 0.594975761928489, 0, 0,
                    0, 0, 0, 0, 0.0357732906740967, 0, 0.101990667876839, 0, 0, 4.4532815735172e-08,
                    0, 0, 0.00799104165067372, 0, 0.0045731769479201, 0, 0.140768524915401,
                    0, 0, 8.30665822228921e-05, 0, 0, 0.0169536958071741, 0, 9.59810194074286e-05,
                    0, 0.020363561952073, 0, 0, 0.000147702973308605, 0, 0, 0.00551566907795945,
                    0, 0, 0, 0, 0, 0, 3.85727697835646e-05, 0, 0, 0, 0, 0, 0, 0,
                    0.0849213026933772, 0, 0, 0, 0, 0, 0, 0, 0, 0.00498608463351133,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00688184314873114, 0, 0.0410096466479079,
                    0, 0, 0, 0, 0, 0, 0, 0.000995526801093188, 0, 0.317711596181992,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0.543109217761054, 0, 0, 0, 0, 0,
                    0, 0, 0, 2.31717306667567e-05, 0.098169539409046, 0, 0),
                  .Dim = c(10L,
                           25L))
    )

    expect_error(spline_interactions(x1, x2, -2), "df must be a positive integer")
    expect_error(spline_interactions(x1, x2, 4.5), "df must be a positive integer")
    x1 <- rnorm(20)
    expect_error(spline_interactions(x1, x2, 5), "x1 and x2 must each be of the same length")
    x1 <- matrix(1:20, 10, 2)
    expect_error(spline_interactions(x1, x2, 5), "x1 must be a numeric vector")
    x1 <- rep("aaa", 10)
    expect_error(spline_interactions(x1, x2, 5), "x1 must be a numeric vector")
    x1 <- rnorm(10)
    x2 <- matrix(1:20, 10, 2)
    expect_error(spline_interactions(x1, x2, 5), "x2 must be a numeric vector")
    x2 <- rep("aaa", 10)
    expect_error(spline_interactions(x1, x2, 5), "x2 must be a numeric vector")

})


test_that("spline_interactions_lattice", {
    set.seed(11)

    expect_equal(
        spline_interactions_lattice(5),
        structure(
            list(
                Var1 = c(1L, 2L, 3L, 4L, 5L, 1L, 2L, 3L, 4L, 5L,
                         1L, 2L, 3L, 4L, 5L, 1L, 2L, 3L, 4L, 5L, 1L, 2L, 3L, 4L, 5L),
                Var2 = c(1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 2L, 3L, 3L,
                         3L, 3L, 3L, 4L, 4L, 4L, 4L, 4L, 5L, 5L, 5L, 5L, 5L)),
            out.attrs = list(dim = c(5L, 5L), dimnames = list(
                Var1 = c("Var1=1", "Var1=2", "Var1=3", "Var1=4", "Var1=5"),
                Var2 = c("Var2=1", "Var2=2", "Var2=3", "Var2=4", "Var2=5"))),
            class = "data.frame", row.names = c(NA, -25L))
    )

    expect_error(spline_interactions_lattice(-1), "df must be a positive integer")
    expect_error(spline_interactions_lattice(4.5), "df must be a positive integer")
    expect_error(spline_interactions_lattice(NA), "df must be a positive integer")
    expect_error(spline_interactions_lattice("aaa"), "df must be a positive integer")
    expect_error(spline_interactions_lattice(c(3, 4)), "df must be a positive integer")

})

test_that("spline_interactions_penalty", {
    set.seed(11)

    expect_equal(
        spline_interactions_penalty(5),
        structure(c(2, -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 3, -1, 0, 0, 0, -1, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 3, -1, 0, 0,
                    0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, -1, 3, -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, -1, 2, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 3, -1, 0, 0, 0, -1,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1,
                    4, -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, -1, 0, 0, 0, -1, 4, -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 4, -1, 0, 0, 0, -1,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1,
                    3, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, -1, 0, 0, 0, 0, 3, -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 4, -1, 0, 0, 0, -1, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 4,
                    -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    -1, 0, 0, 0, -1, 4, -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 3, 0, 0, 0, 0, -1, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 3, -1,
                    0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1,
                    0, 0, 0, -1, 4, -1, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 4, -1, 0, 0, 0, -1, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 4, -1, 0,
                    0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0,
                    0, 0, -1, 3, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, -1, 0, 0, 0, 0, 2, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 3, -1, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0,
                    -1, 3, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, -1, 0, 0, 0, -1, 3, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 2), .Dim = c(25L, 25L
                    ), .Dimnames = list(NULL, NULL))
    )

    expect_error(spline_interactions_penalty(-1), "df must be a positive integer")
    expect_error(spline_interactions_penalty(4.5), "df must be a positive integer")
    expect_error(spline_interactions_penalty(NA), "df must be a positive integer")
    expect_error(spline_interactions_penalty("aaa"), "df must be a positive integer")
    expect_error(spline_interactions_penalty(c(3, 4)), "df must be a positive integer")

    expect_error(spline_interactions_penalty(4, 2), "phi must be a number with values between -1 and 1.")
    expect_error(spline_interactions_penalty(4, -2), "phi must be a number with values between -1 and 1.")
    expect_error(spline_interactions_penalty(4, NA), "phi must be a number with values between -1 and 1.")
    expect_error(spline_interactions_penalty(4, "aaa"), "phi must be a number with values between -1 and 1.")
    expect_error(spline_interactions_penalty(4, c(1, 1)), "phi must be a number with values between -1 and 1.")

})


test_that("build_spline_interactions", {

    set.seed(11)
    X <- matrix(rnorm(40), 10, 4)

    expect_equal(
        build_spline_interactions(X, 5),
        structure(c(0.0269309886823068, 0.0559780617318657, 0.0526010528378343,
                    0.142156123410092, 0.133580219238983, 0.27765641458342, 0, 0,
                    0, 0, 0.000387609619286896, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0.126508063925523, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9.5744165703055e-06, 3.57394844260891e-06,
                    9.60634087797353e-06, 0.00125214061021518, 0.00336560242041438,
                    0.00125631566587425, 0.0463063372933386, 0, 0.00151950676123567,
                    0, 0.000310761679108745, 0, 0.161723868295918, 0.336155081039883,
                    0.315875731178091, 0.326558897180413, 0.306858459793251, 0.168655431620079,
                    0.000318292643574712, 0, 0.0838114478331479, 0, 0.14011960814206,
                    0.0408133428321594, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.000192428777776179,
                    0, 8.87608940883124e-05, 0, 0.0674873773114207, 0.0134587674017832,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0040570309181316, 0, 0, 0, 0.0234518204010565,
                    0, 0, 0, 0, 0.0178590562519801, 0.00666644759077918, 0.0179186043197148,
                    0.0137106601093207, 0.0368525950463972, 0.0234635617579167, 0.0457105214566745,
                    0, 0.0014999555238634, 0, 0.00208327320147133, 0, 0.0707050626450576,
                    0.146965728150217, 0.138099673204292, 0.0707937876998635, 0.066522985115634,
                    0.0199276544056311, 0.000675285762823176, 0, 0.17781333821508,
                    0, 0.16923556326014, 0.18664456408116, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0.0104425338340239, 0, 0.00481678806240464, 0, 0.00515122528774125,
                    0.108211000577316, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00754135479911616,
                    0, 0, 0, 0.181686893256203, 0, 0, 0, 0, 0.0317556788580155, 0.0118537937184168,
                    0.0318615629142006, 0.00665081987290336, 0.0178765989054033,
                    0.0310486322567993, 0.00513003045603798, 0, 0.000168337994730928,
                    0, 0.000799302705269381, 0, 0.0021571289342838, 0.00448375282732432,
                    0.00421325983939199, 0, 0, 0, 0.000219695625257941, 0, 0.0578493056851145,
                    0, 0.00973131071185539, 0.0920161848200225, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0.146214251775004, 0, 0.0674436945761731, 0,
                    0, 0.116486862189085, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00107638279505387,
                    0, 0, 0, 0.310583018245544, 0, 0, 0, 0, 0.00829302526870444,
                    0.00309562932905236, 0.00832067698912341, 5.82399425174154e-06,
                    1.56541917019786e-05, 0.00234194088332659, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0.366851638608272, 0, 0.169216267010264, 0, 0, 0.00340888037474546,
                    0, 0, 0, 0, 0, 0, 0, 0.0126750622154295, 0, 2.93703127840316e-07,
                    0, 0, 0, 0.056139337820723, 0, 0.571861069723527, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0618654599823444, 0.0340024709200686,
                    0.0430883241392031, 0.0863491750663773, 0.109422672639267, 0.227443158367625,
                    0, 0, 0, 0.000154997761272789, 0.000721452874039467, 0, 0, 0,
                    0, 0, 0, 0.00969950571658252, 0.185804728260049, 0, 0, 0, 0,
                    0, 0, 0, 0, 0.0291778737483452, 0.336858568135445, 0, 0.0607446088576184,
                    0.0408052726164397, 0.0354293672218769, 0, 0, 0, 0, 0, 0, 0,
                    0, 0.00503806608053096, 0, 0, 0, 0, 0, 0, 0.000104837723710557,
                    6.6748797520096e-05, 0.000109667552628438, 0.0233855863899735,
                    0.038422265590585, 0.0143423043337037, 0.310426793349085, 0,
                    0.244482708860544, 0, 0.050000341595567, 0, 0.37150962485177,
                    0.204188980719661, 0.258750636316536, 0.19836001929209, 0.251364109026313,
                    0.138154647358241, 0.115061748400981, 0.0335146140260101, 0.15599718610667,
                    0.0560311831589623, 0.260802851563262, 0.0759653579794811, 0,
                    0, 0, 0, 0, 0.0288899552000004, 0.0237528581822273, 0, 0, 0,
                    0, 0, 0.000102653642213684, 2.04718504191456e-05, 0.000236347524112085,
                    0.015565317448529, 0.179701598324398, 0.0358372500151589, 0.0838403077796863,
                    0.0563198393986735, 0.0488999617938794, 0.0164975695062596, 0.0143240912467332,
                    0.00962222754081331, 0, 0, 0, 0.114162173366271, 0.127224858772973,
                    0.141767855587648, 0, 0.0082150813529382, 0, 0, 0, 0, 0.195552678466406,
                    0.124505814104701, 0.204561706400224, 0.256066949537707, 0.420715229459758,
                    0.267863843957176, 0.306432584123885, 0, 0.241336991055076, 0,
                    0.335190529312357, 0, 0.162422600789653, 0.0892706489483502,
                    0.11312479810793, 0.0430019124119804, 0.0544925204103165, 0.0163238031567736,
                    0.244113592033071, 0.0711041934368998, 0.330961713834221, 0.0676741033448028,
                    0.31499600997607, 0.347399162662496, 0, 0, 0, 0, 0, 0.0112895970243611,
                    0.00049852073692603, 0, 0, 0, 0, 0, 0.00557070592242196, 0.00111094605036497,
                    0.0128258727496514, 0.00118808079446605, 0.0137163934118316,
                    0.288138175384916, 0.01212833126282, 0.00814722282140086, 0.00707386400505446,
                    0.0597210526916541, 0.0518530810118205, 0.0509802081628799, 0,
                    0, 0, 0.212208748556875, 0.236490137402329, 0.2262453234009,
                    0, 0.0636442111246541, 0, 0, 0, 0, 0.34771759322475, 0.22138721066105,
                    0.363736793447465, 0.124213943252912, 0.204082165746482, 0.354456244611409,
                    0.034390517525991, 0, 0.0270849265076656, 0, 0.128604686447664,
                    0, 0.00495532397027694, 0.00272354330262712, 0.00345130555090014,
                    0, 0, 0, 0.0794192491360295, 0.0231328440426068, 0.107674179821689,
                    0.00389136724047882, 0.0181127653492073, 0.171268559120603, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0779999003356489, 0.0155552424438654,
                    0.179585282390132, 0, 0, 0.310174674925915, 0, 0, 0, 0.0276995467405492,
                    0.0240502599400618, 0.030778468204933, 0, 0, 0, 0.0302887016976452,
                    0.0337544011494629, 0.0244273625229272, 0, 0.108796021720058,
                    0, 0, 0, 0, 0.0908067750615285, 0.0578154773635601, 0.0949902041995226,
                    0.000108771746238153, 0.000178710803014368, 0.0267359786975506,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0.195701793101858, 0.0390281118988465,
                    0.450579572886834, 0, 0, 0.0090769752247398, 0, 0, 0, 0.0013541658980512,
                    0.00117576082219506, 2.22891121844238e-05, 0.320079763647466,
                    0.356667888233035, 0.397478607592006, 8.26461224361676e-06, 9.21026724091945e-06,
                    0, 0, 0.0196653914029012, 0, 0.200320705600551, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0134116396085355, 0.00401759660465023,
                    0.00354908383677744, 0.0102026747813869, 0.00901288798298094,
                    0.0187339575923242, 0, 0, 0, 0.000708824310355682, 0.000103124492477883,
                    0, 0, 0, 0, 0, 0, 0.065091391929787, 0.310670573035508, 0, 0,
                    0, 0, 0, 0, 0, 0, 0.234595547925787, 0.0603342209341071, 0, 0.2198949357324,
                    0.216193317327573, 0.167759234723489, 0, 0, 0, 0, 0, 0, 0, 0,
                    0.00662096831987313, 0, 0, 0, 0, 0, 0, 5.08550872623645e-05,
                    8.83266952037134e-05, 4.53217490647371e-05, 0.0309454497754124,
                    0.0158785733597525, 0.00592717082166065, 0.119103426058945, 0,
                    0.212854710416646, 0, 0.0435319466176588, 0, 0.0805385299169538,
                    0.0241261571129563, 0.0213126808585106, 0.0234374302349862, 0.0207042699922408,
                    0.0113794731104129, 0.13897084111593, 0.15326655674732, 0.0222982418174525,
                    0.256237667143886, 0.0372791663489509, 0.0108584902346735, 0,
                    0, 0, 0, 0, 0.193874559354327, 0.0397154266837374, 0, 0, 0, 0,
                    0, 7.83542135901592e-06, 0.000164597496293114, 4.23318421613491e-05,
                    0.125148055919721, 0.0321860773663236, 0.00641875482655391, 0.303501157348987,
                    0.298392147147422, 0.231542949022347, 0.0874069464729789, 0.0678250495023685,
                    0.0455615681328164, 0, 0, 0, 0.182189804073272, 0.167197441631694,
                    0.186309680265894, 0, 0.000606447248474448, 0, 0, 0, 0, 0.0948594473040509,
                    0.164754834575188, 0.0845381710772422, 0.338845765674689, 0.173866832990162,
                    0.110698721986388, 0.117570942351643, 0, 0.210115944736014, 0,
                    0.291827930832856, 0, 0.0352111402177164, 0.0105478645052861,
                    0.00931782334366255, 0.00508093478576793, 0.00448842064009537,
                    0.00134455324257392, 0.294838829446968, 0.32516844412743, 0.0473076759368445,
                    0.309482209539115, 0.0450255378143566, 0.0496572452975652, 0,
                    0, 0, 0, 0, 0.0757621683119085, 0.000833540268114879, 0, 0, 0,
                    0, 0, 0.000425204865877842, 0.00893221348646556, 0.00229722237565014,
                    0.00955239121814607, 0.00245672216416899, 0.0516079861926919,
                    0.0439044496908399, 0.0431653807418979, 0.0334949818492158, 0.316412357223212,
                    0.245526066952354, 0.241392984918115, 0, 0, 0, 0.338660952066581,
                    0.310792610234728, 0.29732899386642, 0, 0.00469829269603871,
                    0, 0, 0, 0, 0.168672190889274, 0.292955100384716, 0.150319645903754,
                    0.16436861057232, 0.0843399937617615, 0.146484320910628, 0.0131948290194127,
                    0, 0.0235810303939893, 0, 0.1119674819525, 0, 0.00107425078956591,
                    0.000321803034578716, 0.000284275914442804, 0, 0, 0, 0.0959220592995566,
                    0.105789413281964, 0.0153909500490485, 0.0177957131633574, 0.00258903914756018,
                    0.0244811322711068, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00595363273929298,
                    0.125067051002783, 0.0321652441979258, 0, 0, 0.0555549097911631,
                    0, 0, 0, 0.146756938854437, 0.1138787824569, 0.145737072854988,
                    0, 0, 0, 0.0483373123094216, 0.0443596445728496, 0.0321021580140355,
                    0, 0.00803145400300842, 0, 0, 0, 0, 0.0440489005896159, 0.0765054987786246,
                    0.0392561162819506, 0.000143934411310713, 7.38549003351656e-05,
                    0.0110490412933345, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.014937667837212,
                    0.313793300169382, 0.0807026154906029, 0, 0, 0.00162576309593131,
                    0, 0, 0, 0.00717460266626457, 0.00556726668342834, 0.000105539689131564,
                    0.594975761928489, 0.569201257827517, 0.522361800466223, 1.31893782415584e-05,
                    1.21040269510054e-05, 0, 0, 0.00145172299507382, 0, 0.0147879169425954,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0.000349451960027359, 0, 0, 0, 0, 0, 0, 0, 0.0954568033877869,
                    0.0357732906740967, 0, 0, 0, 0, 0, 0, 0, 0, 0.252537164573012,
                    0, 0, 0.101990667876839, 0.130523185041263, 0.161901054686794,
                    0, 0, 0, 0, 0, 0, 0, 0, 0.00101602781502539, 0, 0, 0, 0, 0, 0,
                    4.4532815735172e-08, 6.66231919254362e-06, 7.16117787813097e-07,
                    0.0023341580196692, 0.000250893424518367, 9.36537654523238e-05,
                    0, 0, 0.016979630662943, 0, 0.0034725864142727, 0, 0, 0, 0, 0,
                    0, 0, 0.00799104165067372, 0.0755607530378296, 0, 0.126325739267234,
                    0, 0, 0, 0, 0, 0, 0, 0.2843178667026, 0.0045731769479201, 0,
                    0, 0, 0, 0, 0, 0.000177185736801917, 0, 0.134719245412914, 0,
                    0, 0.140768524915401, 0.180149386291949, 0.223457431203695, 0.0527705166348793,
                    0.0654565876311785, 0.0439705506885839, 0, 0, 0, 0.0196707552897918,
                    0.0256574632427994, 0.0285903523794933, 0, 0, 0, 0, 0, 0, 8.30665822228921e-05,
                    0.012427152333992, 0.0013357668074797, 0.0255585091546787, 0.00274722698007829,
                    0.00174912322535028, 0, 0, 0.0167611566172502, 0, 0.0232794025228453,
                    0, 0, 0, 0, 0, 0, 0, 0.0169536958071741, 0.160308765485707, 0,
                    0.152575416978536, 0, 0, 0, 0, 0, 0, 0, 0.111105542382368, 9.59810194074286e-05,
                    0, 0, 0, 0, 0, 0, 0.00961533962249964, 0, 0.0102829478839295,
                    0, 0, 0.020363561952073, 0.026060393760528, 0.0323253315803531,
                    0.19102879386698, 0.236952256358385, 0.23296350222778, 0, 0,
                    0, 0.0365647065059164, 0.047693014291432, 0.0456269405601966,
                    0, 0, 0, 0, 0, 0, 0.000147702973308605, 0.0220970611811658, 0.00237516367992954,
                    0.0123980201720675, 0.0013326354565569, 0.00231456265489632,
                    0, 0, 0.00188108210505572, 0, 0.00893175671842919, 0, 0, 0, 0,
                    0, 0, 0, 0.00551566907795945, 0.0521544158142324, 0, 0.00877332613197112,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.134632045326549,
                    0, 0, 0, 0, 0, 0, 0, 0.0886021053886853, 0.109902116665049, 0.140647910328629,
                    0, 0, 0, 0.00521890589125652, 0.00680725697106474, 0.00492627118705579,
                    0, 0, 0, 0, 0, 0, 3.85727697835646e-05, 0.00577066821839525,
                    0.000620276219035793, 1.0856706330189e-05, 1.16696307928517e-06,
                    0.000174583178533914, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.337791876220313,
                    0, 0, 0, 0, 0, 0, 0, 0.00433154920319528, 0.00537285681623044,
                    0.000101854225848613, 0.0849213026933772, 0.0614557917240185,
                    0.080159591941771, 1.42403705374125e-06, 1.85743647483184e-06,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0242127823227379,
                    0, 0.532248591969654, 0, 0, 0, 0, 0, 0, 0, 0.00739026674793092,
                    0, 0, 0.00498608463351133, 9.45221150930033e-05, 0.022526640468209,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.571861069723527,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0.0721177157899261, 0, 0.0680414618138848,
                    0, 0.349093884067321, 0, 0, 0, 5.18517684756955e-06, 0, 0.00394243422097803,
                    0, 0, 0.00688184314873114, 0.000130460354761021, 0.0310914911728847,
                    3.82152860068686e-05, 0.0091075195198444, 0.00611798847430042,
                    0, 0, 0, 0, 0, 0, 0.0410096466479079, 0, 0.0410096466479079,
                    0, 0, 0.200320705600551, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.028182111877614,
                    0, 0.00142804202444834, 0, 0.583694494870962, 0, 0, 0, 0.000281384028376058,
                    0, 0.000300920967200214, 0, 0, 0.000995526801093188, 1.88723829994102e-05,
                    0.00449769227220268, 0.000138338990381395, 0.0329691384496682,
                    0.0324141499081171, 0, 0, 0, 0, 0, 0, 0.317711596181992, 0, 0.317711596181992,
                    0, 0, 0.0147879169425954, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0.0672116210617168, 0, 0, 0, 0.00393988239103343, 0, 0, 0, 0,
                    0, 0, 0, 6.41637606405645e-05, 0.0152915956823019, 0.01956951370519,
                    0, 0, 0, 0, 0, 0, 0.543109217761054, 0, 0.543109217761054, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00988516709915952,
                    0, 0, 0, 0, 0, 0, 0, 3.13681582460615e-06, 0.00074757026148182,
                    1.4171825688833e-05, 2.31717306667567e-05, 0, 0, 0, 0, 0, 0.098169539409046,
                    0, 0.098169539409046, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                    0, 0),
                  .Dim = c(6L, 10L, 25L),
                  .Dimnames = list(
                      variables = c("Var-1:Var-2", "Var-1:Var-3", "Var-1:Var-4", "Var-2:Var-3", "Var-2:Var-4", "Var-3:Var-4"),
                      observation = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"),
                      knot = c("1", "2", "3", "4", "5", "6", "7", "8", "9",
                               "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
                               "21", "22", "23", "24", "25")))
    )

    # check that build_spline_interactions and spline_interactions give the same basis expansion

    expect_equal(
        build_spline_interactions(X, 5)[1, , ],
        spline_interactions(X[, 1], X[, 2], 5),
        check.attributes = FALSE
    )

    expect_error(build_spline_interactions(X, -1), "df must be a positive integer")
    expect_error(build_spline_interactions(X, 4.5), "df must be a positive integer")
    expect_error(build_spline_interactions(X, NA), "df must be a positive integer")
    expect_error(build_spline_interactions(X, "aaa"), "df must be a positive integer")
    expect_error(build_spline_interactions(X, c(3, 4)), "df must be a positive integer")

    X <- rnorm(10)
    expect_error(build_spline_interactions(X, 5), "X must be a numeric matrix with at least 2 columns")
    X <- matrix(rnorm(10), 10, 1)
    expect_error(build_spline_interactions(X, 5), "X must be a numeric matrix with at least 2 columns")
    X <- matrix("aaa", 10, 2)
    expect_error(build_spline_interactions(X, 5), "X must be a numeric matrix with at least 2 columns")

})
